{% extends "auth/base_auth.html" %}

{% block title %}Forgot Password - GearGuard{% endblock %}

{% block content %}
<div class="auth-container">
    <!-- Brand and Title -->
    <div class="auth-brand">
        <div class="brand-icon">
            <i class="fas fa-key"></i>
        </div>
        <h1>Reset Your Password</h1>
        <p>Enter your email address and we'll send you instructions to reset your password.</p>
    </div>
    
    <!-- Forgot Password Form -->
    <form class="auth-form" id="forgotPasswordForm" novalidate>
        <!-- Email Field -->
        <div class="form-group">
            <label for="email">Work Email</label>
            <input 
                type="email" 
                id="email" 
                name="email" 
                class="form-control" 
                placeholder="your.email@company.com"
                autocomplete="email"
                required
                aria-describedby="emailError"
            >
            <div id="emailError" class="error-message" role="alert">
                Please enter a valid email address
            </div>
        </div>
        
        <!-- Primary Action Button -->
        <button type="submit" class="btn-primary-auth" id="resetButton">
            <span class="spinner"></span>
            Send Reset Link
        </button>
    </form>
    
    <!-- Success Message (hidden by default) -->
    <div id="successMessage" style="display: none; margin-top: 24px; padding: 16px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724;">
        <i class="fas fa-check-circle"></i> 
        <strong>Check your email!</strong> If an account exists with this email, we've sent password reset instructions.
    </div>
    
    <!-- Secondary Action - Back to Sign In -->
    <div class="auth-footer">
        <p>Remember your password?</p>
        <a href="/auth/signin">Back to Sign In</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    /**
     * Forgot Password Form
     * Sends password reset request
     */
    (function() {
        const form = document.getElementById('forgotPasswordForm');
        const emailInput = document.getElementById('email');
        const emailError = document.getElementById('emailError');
        const resetButton = document.getElementById('resetButton');
        const successMessage = document.getElementById('successMessage');
        
        function validateEmail(email) {
            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            return emailRegex.test(email);
        }
        
        emailInput.addEventListener('blur', function() {
            const email = this.value.trim();
            if (!email) {
                showError(emailInput, emailError, 'Email is required');
            } else if (!validateEmail(email)) {
                showError(emailInput, emailError, 'Please enter a valid email address');
            } else {
                clearError(emailInput, emailError);
            }
        });
        
        emailInput.addEventListener('input', function() {
            if (this.value.trim()) {
                clearError(emailInput, emailError);
            }
        });
        
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = emailInput.value.trim();
            
            if (!email) {
                showError(emailInput, emailError, 'Email is required');
                return;
            }
            
            if (!validateEmail(email)) {
                showError(emailInput, emailError, 'Please enter a valid email address');
                return;
            }
            
            // Show loading state
            resetButton.classList.add('loading');
            resetButton.disabled = true;
            
            // Submit to backend
            $.ajax({
                url: '/api/auth/forgot-password',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ email }),
                success: function(response) {
                    // Hide form, show success message
                    form.style.display = 'none';
                    successMessage.style.display = 'block';
                },
                error: function(xhr) {
                    // For security, don't reveal if email exists or not
                    // Show success message regardless
                    form.style.display = 'none';
                    successMessage.style.display = 'block';
                }
            });
        });
        
        function showError(input, errorElement, message) {
            input.classList.add('is-invalid');
            errorElement.textContent = message;
            errorElement.classList.add('show');
        }
        
        function clearError(input, errorElement) {
            input.classList.remove('is-invalid');
            errorElement.classList.remove('show');
        }
    })();
</script>
{% endblock %}
