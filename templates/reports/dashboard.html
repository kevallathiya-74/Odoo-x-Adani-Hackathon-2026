{% extends "base.html" %}

{% block title %}Reports & Analytics - GearGuard{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-8">
        <h2><i class="fas fa-chart-bar"></i> Reports & Analytics</h2>
    </div>
    <div class="col-md-4 text-end">
        <button class="btn btn-outline-primary" onclick="exportData('excel')">
            <i class="fas fa-file-excel"></i> Export Excel
        </button>
        <button class="btn btn-outline-danger" onclick="exportData('pdf')">
            <i class="fas fa-file-pdf"></i> Export PDF
        </button>
    </div>
</div>

<!-- Key Metrics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card bg-primary text-white">
            <div class="stat-icon"><i class="fas fa-tools"></i></div>
            <div class="stat-content">
                <h3 id="totalRequests">0</h3>
                <p>Total Requests</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card bg-success text-white">
            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
            <div class="stat-content">
                <h3 id="completedRequests">0</h3>
                <p>Completed</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card bg-warning text-white">
            <div class="stat-icon"><i class="fas fa-spinner"></i></div>
            <div class="stat-content">
                <h3 id="activeRequests">0</h3>
                <p>Active</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card bg-danger text-white">
            <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <div class="stat-content">
                <h3 id="overdueRequests">0</h3>
                <p>Overdue</p>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="chart-container">
            <h5><i class="fas fa-chart-pie"></i> Maintenance by Type</h5>
            <canvas id="typeChart"></canvas>
        </div>
    </div>
    <div class="col-md-6">
        <div class="chart-container">
            <h5><i class="fas fa-chart-bar"></i> Maintenance by Status</h5>
            <canvas id="statusChart"></canvas>
        </div>
    </div>
</div>

<!-- Charts Row 2 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="chart-container">
            <h5><i class="fas fa-chart-line"></i> Equipment by Category</h5>
            <canvas id="categoryChart"></canvas>
        </div>
    </div>
    <div class="col-md-6">
        <div class="chart-container">
            <h5><i class="fas fa-users"></i> Team Workload</h5>
            <canvas id="teamChart"></canvas>
        </div>
    </div>
</div>

<!-- Pivot Table -->
<div class="row mb-4">
    <div class="col-12">
        <div class="chart-container">
            <h5><i class="fas fa-table"></i> Pivot Analysis</h5>
            
            <!-- Pivot Controls -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="form-label">Group By:</label>
                    <select class="form-select form-select-sm" id="groupByField">
                        <option value="equipment_category">Equipment Category</option>
                        <option value="team_name">Team</option>
                        <option value="maintenance_type">Maintenance Type</option>
                        <option value="state">Status</option>
                        <option value="priority">Priority</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Measure:</label>
                    <select class="form-select form-select-sm" id="measureField">
                        <option value="count">Count</option>
                        <option value="duration">Total Duration</option>
                        <option value="cost">Total Cost</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Filter State:</label>
                    <select class="form-select form-select-sm" id="pivotStateFilter">
                        <option value="">All</option>
                        <option value="new">New</option>
                        <option value="in_progress">In Progress</option>
                        <option value="done">Done</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-primary btn-sm w-100" onclick="refreshPivot()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="pivotTable">
                    <thead class="table-light">
                        <tr>
                            <th>Category</th>
                            <th class="text-end">Value</th>
                            <th class="text-end">Percentage</th>
                        </tr>
                    </thead>
                    <tbody id="pivotTableBody">
                        <tr>
                            <td colspan="3" class="text-center">
                                <div class="spinner-border text-primary" role="status"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Top Equipment by Maintenance -->
<div class="row">
    <div class="col-12">
        <div class="chart-container">
            <h5><i class="fas fa-trophy"></i> Top 10 Equipment by Maintenance Frequency</h5>
            <div class="table-responsive">
                <table class="table table-sm table-hover" id="topEquipmentTable">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 5%;">#</th>
                            <th style="width: 35%;">Equipment</th>
                            <th style="width: 15%;">Category</th>
                            <th style="width: 15%;">Total Requests</th>
                            <th style="width: 15%;">Completed</th>
                            <th style="width: 15%;">Average Duration</th>
                        </tr>
                    </thead>
                    <tbody id="topEquipmentBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .stat-icon {
        font-size: 40px;
        opacity: 0.8;
    }
    
    .stat-content h3 {
        margin: 0;
        font-size: 32px;
        font-weight: bold;
    }
    
    .stat-content p {
        margin: 0;
        font-size: 14px;
        opacity: 0.9;
    }
    
    .chart-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .chart-container h5 {
        margin-bottom: 20px;
        color: #495057;
        font-weight: 600;
    }
    
    .chart-container canvas {
        max-height: 300px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    let charts = {};
    let pivotData = [];
    
    $(document).ready(function() {
        loadDashboardStats();
        loadChartData();
        loadPivotData();
        loadTopEquipment();
        
        // Pivot controls - rerender on filter change
        $('#groupByField, #measureField, #pivotStateFilter').on('change', renderPivotTable);
    });
    
    function loadDashboardStats() {
        $.ajax({
            url: '/api/dashboard/stats',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    const data = response.data;
                    $('#totalRequests').text(data.requests.total);
                    $('#completedRequests').text(data.requests.completed);
                    $('#activeRequests').text(data.requests.in_progress + data.requests.new);
                    $('#overdueRequests').text(data.requests.overdue);
                }
            }
        });
    }
    
    function loadChartData() {
        $.ajax({
            url: '/api/reports/charts',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    const data = response.data;
                    createTypeChart(data.maintenance_by_type);
                    createStatusChart(data.maintenance_by_state);
                    createCategoryChart(data.equipment_by_category);
                    createTeamChart(data);
                }
            }
        });
    }
    
    function createTypeChart(data) {
        const ctx = document.getElementById('typeChart').getContext('2d');
        charts.type = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Corrective', 'Preventive'],
                datasets: [{
                    data: [data.corrective, data.preventive],
                    backgroundColor: ['#ffc107', '#28a745']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
    
    function createStatusChart(data) {
        const ctx = document.getElementById('statusChart').getContext('2d');
        charts.status = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['New', 'In Progress', 'Done', 'Cancelled'],
                datasets: [{
                    label: 'Requests',
                    data: [data.new, data.in_progress, data.done, data.cancelled],
                    backgroundColor: ['#17a2b8', '#ffc107', '#28a745', '#6c757d']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
    
    function createCategoryChart(data) {
        const ctx = document.getElementById('categoryChart').getContext('2d');
        const labels = Object.keys(data);
        const values = Object.values(data);
        
        charts.category = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6c757d']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
    
    function createTeamChart(data) {
        const teamWorkload = data.team_workload || {};
        const labels = Object.keys(teamWorkload);
        const values = Object.values(teamWorkload);
        
        const ctx = document.getElementById('teamChart').getContext('2d');
        charts.team = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels.length > 0 ? labels : ['No Data'],
                datasets: [{
                    label: 'Active Requests',
                    data: values.length > 0 ? values : [0],
                    backgroundColor: '#007bff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: true }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                }
            }
        });
    }
    
    function loadPivotData() {
        $.ajax({
            url: '/api/reports/pivot',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    pivotData = response.data;
                    renderPivotTable();
                }
            }
        });
    }
    
    function refreshPivot() {
        // Show loading
        $('#pivotTableBody').html('<tr><td colspan="3" class="text-center"><div class="spinner-border text-primary" role="status"></div></td></tr>');
        
        // Reload data from API
        $.ajax({
            url: '/api/reports/pivot',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    // Update the global pivotData array with fresh data
                    pivotData = response.data;
                    // Re-render the table with the fresh data
                    renderPivotTable();
                } else {
                    $('#pivotTableBody').html('<tr><td colspan="3" class="text-center text-danger">Failed to load data</td></tr>');
                }
            },
            error: function() {
                $('#pivotTableBody').html('<tr><td colspan="3" class="text-center text-danger">Failed to load data</td></tr>');
            }
        });
    }
    
    function renderPivotTable() {
        const groupBy = $('#groupByField').val();
        const measure = $('#measureField').val();
        const stateFilter = $('#pivotStateFilter').val();
        
        // Filter data
        let filtered = pivotData;
        if (stateFilter) {
            filtered = pivotData.filter(d => d.state === stateFilter);
        }
        
        // Group data
        const grouped = {};
        filtered.forEach(item => {
            const key = item[groupBy] || 'N/A';
            if (!grouped[key]) {
                grouped[key] = { count: 0, duration: 0, cost: 0 };
            }
            grouped[key].count++;
            grouped[key].duration += item.duration || 0;
            grouped[key].cost += item.cost || 0;
        });
        
        // Sort by measure
        const sorted = Object.entries(grouped)
            .sort((a, b) => b[1][measure] - a[1][measure]);
        
        // Calculate total
        const total = sorted.reduce((sum, [_, val]) => sum + val[measure], 0);
        
        // Render table
        const tbody = $('#pivotTableBody');
        tbody.empty();
        
        if (sorted.length === 0) {
            tbody.append('<tr><td colspan="3" class="text-center text-muted">No data</td></tr>');
            return;
        }
        
        sorted.forEach(([key, val]) => {
            const value = val[measure];
            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
            
            tbody.append(`
                <tr>
                    <td><strong>${key}</strong></td>
                    <td class="text-end">${formatValue(value, measure)}</td>
                    <td class="text-end">
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar" role="progressbar" 
                                 style="width: ${percentage}%"
                                 aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100">
                                ${percentage}%
                            </div>
                        </div>
                    </td>
                </tr>
            `);
        });
        
        // Add total row
        tbody.append(`
            <tr class="table-secondary fw-bold">
                <td>TOTAL</td>
                <td class="text-end">${formatValue(total, measure)}</td>
                <td class="text-end">100%</td>
            </tr>
        `);
    }
    
    function formatValue(value, measure) {
        if (measure === 'count') return value;
        if (measure === 'duration') return value.toFixed(1) + ' hrs';
        if (measure === 'cost') return '$' + value.toFixed(2);
        return value;
    }
    
    function loadTopEquipment() {
        // Aggregate maintenance counts per equipment
        $.ajax({
            url: '/api/reports/pivot',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    const data = response.data;
                    
                    // Group by equipment
                    const equipment = {};
                    data.forEach(item => {
                        const key = item.equipment_name;
                        if (!equipment[key]) {
                            equipment[key] = {
                                name: key,
                                category: item.equipment_category,
                                total: 0,
                                completed: 0,
                                totalDuration: 0,
                                count: 0
                            };
                        }
                        equipment[key].total++;
                        if (item.state === 'done') {
                            equipment[key].completed++;
                            equipment[key].totalDuration += item.duration || 0;
                            equipment[key].count++;
                        }
                    });
                    
                    // Sort and get top 10
                    const top10 = Object.values(equipment)
                        .sort((a, b) => b.total - a.total)
                        .slice(0, 10);
                    
                    // Render table
                    const tbody = $('#topEquipmentBody');
                    tbody.empty();
                    
                    top10.forEach((item, index) => {
                        const avgDuration = item.count > 0 ? 
                            (item.totalDuration / item.count).toFixed(1) : '0.0';
                        
                        tbody.append(`
                            <tr>
                                <td><strong>${index + 1}</strong></td>
                                <td>${item.name}</td>
                                <td><span class="badge bg-secondary">${item.category}</span></td>
                                <td>${item.total}</td>
                                <td>${item.completed}</td>
                                <td>${avgDuration} hrs</td>
                            </tr>
                        `);
                    });
                }
            }
        });
    }
    
    function exportData(format) {
        if (format === 'excel') {
            exportToExcel();
        } else if (format === 'pdf') {
            exportToPDF();
        }
    }
    
    function exportToExcel() {
        // Fetch fresh data from API before exporting
        showToast('Preparing export...', 'info');
        
        $.when(
            $.ajax({ url: '/api/dashboard/stats', method: 'GET' }),
            $.ajax({ url: '/api/reports/pivot', method: 'GET' })
        ).done(function(statsResponse, pivotResponse) {
            const stats = statsResponse[0].data.requests;
            const freshPivotData = pivotResponse[0].data;
            
            // Create CSV content
            let csv = 'Maintenance Management Report\n';
            csv += 'Generated: ' + new Date().toLocaleString() + '\n\n';
            
            csv += 'SUMMARY STATISTICS\n';
            csv += 'Total Requests,' + stats.total + '\n';
            csv += 'Completed,' + stats.completed + '\n';
            csv += 'Active,' + (stats.in_progress + stats.new) + '\n';
            csv += 'Overdue,' + stats.overdue + '\n\n';
            
            csv += 'MAINTENANCE REQUESTS DETAIL\n';
            csv += 'Reference,Equipment,Type,Priority,Status,Scheduled Date,Team,Duration,Cost\n';
            
            freshPivotData.forEach(row => {
                csv += `"${row.name || 'N/A'}","${row.equipment_name || 'N/A'}","${row.maintenance_type}",`;
                csv += `"${row.priority}","${row.state}","${row.schedule_date || 'N/A'}",`;
                csv += `"${row.team_name || 'N/A'}","${row.duration || 0}","${row.cost || 0}"\n`;
            });
            
            // Download file
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'maintenance_report_' + new Date().toISOString().split('T')[0] + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Report exported to Excel (CSV)', 'success');
        }).fail(function() {
            showToast('Error fetching data for export', 'error');
        });
    }
    
    function exportToPDF() {
        // Fetch fresh data from API before exporting
        showToast('Preparing PDF export...', 'info');
        
        $.when(
            $.ajax({ url: '/api/dashboard/stats', method: 'GET' }),
            $.ajax({ url: '/api/reports/pivot', method: 'GET' })
        ).done(function(statsResponse, pivotResponse) {
            const stats = statsResponse[0].data.requests;
            const freshPivotData = pivotResponse[0].data;
            
            // Open print dialog with formatted report
            const printWindow = window.open('', '', 'height=600,width=800');
            
            let html = `
                <html>
                <head>
                    <title>Maintenance Management Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #714B67; border-bottom: 3px solid #714B67; padding-bottom: 10px; }
                        h2 { color: #333; margin-top: 30px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                        th { background-color: #714B67; color: white; padding: 10px; text-align: left; }
                        td { padding: 8px; border-bottom: 1px solid #ddd; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                        .stats { display: flex; justify-content: space-around; margin: 20px 0; }
                        .stat-box { text-align: center; padding: 20px; background: #f5f5f5; border-radius: 8px; }
                        .stat-box h3 { margin: 0; font-size: 32px; color: #714B67; }
                        .stat-box p { margin: 5px 0 0 0; color: #666; }
                        @media print {
                            body { padding: 10mm; }
                        }
                    </style>
                </head>
                <body>
                    <h1>ðŸ”§ GearGuard Maintenance Management Report</h1>
                    <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
                    
                    <h2>Summary Statistics</h2>
                    <div class="stats">
                        <div class="stat-box">
                            <h3>${stats.total}</h3>
                            <p>Total Requests</p>
                        </div>
                        <div class="stat-box">
                            <h3>${stats.completed}</h3>
                            <p>Completed</p>
                        </div>
                        <div class="stat-box">
                            <h3>${stats.in_progress + stats.new}</h3>
                            <p>Active</p>
                        </div>
                        <div class="stat-box">
                            <h3>${stats.overdue}</h3>
                            <p>Overdue</p>
                        </div>
                    </div>
                    
                    <h2>Maintenance Requests</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Reference</th>
                                <th>Equipment</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Scheduled</th>
                                <th>Team</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            freshPivotData.slice(0, 50).forEach(row => {
                html += `
                            <tr>
                                <td>${row.name || 'N/A'}</td>
                                <td>${row.equipment_name || 'N/A'}</td>
                                <td>${row.maintenance_type}</td>
                                <td>${row.state}</td>
                                <td>${row.schedule_date || 'N/A'}</td>
                                <td>${row.team_name || 'N/A'}</td>
                            </tr>`;
            });
            
            html += `
                        </tbody>
                    </table>
                    ${freshPivotData.length > 50 ? '<p><em>Showing first 50 records. Export to Excel for full data.</em></p>' : ''}
                    
                    <h2>Pivot Analysis</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Count</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            // Add pivot table from current view
            $('#pivotTableBody tr').each(function() {
                const cells = $(this).find('td');
                if (cells.length >= 2) {
                    html += `<tr><td>${cells.eq(0).text()}</td><td>${cells.eq(1).text()}</td></tr>`;
                }
            });
            
            html += `
                        </tbody>
                    </table>
                    
                    <p style="margin-top: 40px; text-align: center; color: #999; font-size: 12px;">
                        Â© 2026 GearGuard - Maintenance Management System | Odoo Ã— Adani Hackathon
                    </p>
                </body>
                </html>`;
            
            printWindow.document.write(html);
            printWindow.document.close();
            
            // Wait for content to load, then print
            setTimeout(() => {
                printWindow.print();
            }, 500);
            
            showToast('Opening print dialog for PDF export', 'success');
        }).fail(function() {
            showToast('Error fetching data for export', 'error');
        });
    }
</script>
{% endblock %}
